#!/usr/bin/env python
# -*- coding: utf-8 -*-
from engine.engine_utils.common import *
from engine.logger import scanLogger as logger
'''
CVE-2014-0160
CNNVD-201404-073
OpenSSL 缓冲区溢出漏洞
CVSS分值:	5	[中等(MEDIUM)]
受影响：OpenSSL Project OpenSSL 1.0.X
CWE-119	[内存缓冲区边界内操作的限制不恰当]
OpenSSL是OpenSSL团队开发的一个开源的能够实现安全套接层（SSL v2/v3）和安全传输层（TLS v1）协议的通用加密库，它支持多种加密算法，包括对称密码、哈希算法、安全散列算法等。
OpenSSL的TLS和DTLS实现过程中的d1_both.c和t1_lib.c文件中存在安全漏洞，该漏洞源于当处理Heartbeat Extension数据包时，缺少边界检查。远程攻击者可借助特制的数据包利用该漏洞读取服务器内存中的敏感信息(如用户名、密码、Cookie、私钥等)。以下版本的OpenSSL受到影响：1.0.1，1.0.1:beta1，1.0.1:beta2，1.0.1:beta3，1.0.1a，1.0.1b，1.0.1c，1.0.1d，1.0.1e，1.0.1f。目前OpenSSL官方已经发布补丁，用户可以通过升级修复漏洞，或者使用-DOPENSSL_NO_HEARTBEATS参数重新编译受影响版本的OpenSSL以禁用Heartbeat模块。
'''

def run_domain(http,ob):
    list = []
    try:
        domain = ob['domain']
        detail = u'OpenSSL 缓冲区溢出漏洞'
        detail = detail.encode('utf8')
        url = "%s://%s%s" % (ob['scheme'],ob['domain'],ob['path'])
        content = ''.join(popen('python plugins/ssltest.py %s'%domain))
        if content.find('server is vulnerable!') !=-1:           
            if ob['isstart']=='1':
                contentnew = content[1000:2075]
                detail="验证性扫描结果：\n%s\n%s"%(contentnew,detail)
            list.append(getRecord(ob,url,ob['level'],detail))
    except Exception,e:
        logger.error("File:OpenSSLVulnerability.py, run_domain function :" + str(e))
    #end try
    
    return list
#end def
